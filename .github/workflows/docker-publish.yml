# UVR Headless Runner - Docker Hub è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# 
# è§¦å‘æ¡ä»¶ï¼š
#   - æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ (v1.0.0, v1.2.3 ç­‰)
#   - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# ä½¿ç”¨å‰é…ç½®ï¼š
#   1. Docker Hub: Account Settings â†’ Security â†’ New Access Token
#   2. GitHub: Settings â†’ Secrets â†’ Actions â†’ New repository secret
#      - DOCKERHUB_USERNAME: ä½ çš„ Docker Hub ç”¨æˆ·å
#      - DOCKERHUB_TOKEN: Docker Hub Access Token

name: Build and Push Docker Image

on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v1.2.3 ç­‰æ ‡ç­¾
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      tag:
        description: 'Docker image tag (without v prefix)'
        required: true
        default: 'latest'

env:
  REGISTRY: docker.io
  IMAGE_NAME: chyinan/uvr-headless-runner

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # è®¾ç½® Docker Buildxï¼ˆæ”¯æŒå¤šå¹³å°æž„å»ºï¼‰
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # ç™»å½• Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # ä»Žæ ‡ç­¾æå–ç‰ˆæœ¬å·
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            # ä»Ž refs/tags/v1.0.0 æå– 1.0.0
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # æå–ä¸»ç‰ˆæœ¬å·å’Œæ¬¡ç‰ˆæœ¬å·ç”¨äºŽé¢å¤–æ ‡ç­¾
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
          echo "MINOR=$MINOR" >> $GITHUB_OUTPUT
      
      # ç”Ÿæˆ Docker å…ƒæ•°æ®ï¼ˆæ ‡ç­¾å’Œæ ‡æ³¨ï¼‰
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            # å®Œæ•´ç‰ˆæœ¬: 1.0.0
            type=raw,value=${{ steps.version.outputs.VERSION }}
            # ä¸».æ¬¡ç‰ˆæœ¬: 1.0
            type=raw,value=${{ steps.version.outputs.MAJOR }}.${{ steps.version.outputs.MINOR }}
            # ä¸»ç‰ˆæœ¬: 1
            type=raw,value=${{ steps.version.outputs.MAJOR }}
            # latest æ ‡ç­¾
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=UVR Headless Runner
            org.opencontainers.image.description=Audio source separation CLI powered by Ultimate Vocal Remover
            org.opencontainers.image.vendor=chyinan
            org.opencontainers.image.licenses=MIT
      
      # æž„å»ºå¹¶æŽ¨é€ GPU é•œåƒ
      - name: Build and push GPU image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          target: gpu
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            CUDA_VERSION=cu124
      
      # æž„å»ºå¹¶æŽ¨é€ CPU é•œåƒï¼ˆä½¿ç”¨ -cpu åŽç¼€ï¼‰
      - name: Build and push CPU image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          target: cpu
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}-cpu
            ${{ env.IMAGE_NAME }}:latest-cpu
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      # è¾“å‡ºæž„å»ºä¿¡æ¯
      - name: Image digest
        run: |
          echo "## ðŸ³ Docker Image Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GPU Image" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CPU Image" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}-cpu\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:latest-cpu\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Start" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "docker run --rm --gpus all ${{ env.IMAGE_NAME }}:latest uvr-mdx --list" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
